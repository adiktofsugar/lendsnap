#!/bin/bash
current_directory=$(cd `dirname ${BASH_SOURCE[0]}` && pwd)
project_root=$(cd $current_directory/.. && pwd)

build=false
test_mode=false
db_setup=false
while getopts ":t:b:d" opt; do
    case $opt in
        b)
            build=true
            shift
            ;;
        t)
            test_mode=true
            shift
            ;;
        d)
            db_setup=true
            shift
            ;;
        *)
            echo "Unsupported option: $OPTARG"
            exit 1
            ;;
    esac
done

echo "test mode: $test_mode"
if [ "$test_mode" = "true" ]; then
    # echo "Starting shell into node"
    echo "starting node bash"
    docker run \
        -it --rm \
        -v $project_root:/var/lendsnap \
        --link db:db \
        node /bin/bash


    exit
fi

if [ $build ];then
    docker pull mysql
    docker build -t node $project_root/node
    docker build -t nginx $project_root/nginx
fi

echo "Starting mysql..."
# start mysql
docker run --name db -d \
    -e MYSQL_ROOT_PASSWORD=a \
    mysql

if [[ `docker ps -a | grep is-mysqld-up` ]];then
    docker rm -f is-mysqld-up
fi
mysqld_status() {
    docker run -t --name is-mysqld-up --rm --link db:db mysql \
        mysqladmin -u root -pa -h db status
}
while [ true ];do
    status=`mysqld_status`
    
    if [[ `echo $status | grep 'Uptime'` ]];then
        break
    else
        echo "waiting a second..."
        sleep 1s;
    fi
done


# if [[ "$db_setup" = "true" ]];then
#     echo "Starting node db setup"
#     docker run -t --rm \
#         -v $project_root:/var/lendsnap \
#         --link db:db \
#         node scripts/db-setup.js
#     if [[ $? -gt 0 ]];then
#         exit $?
#     fi
# fi

echo "Starting node webapp on port 3000"
docker run --name node-webapp -t -d \
    -v $project_root:/var/lendsnap \
    -p 3000:3000 \
    --link db:db \
    node
if [[ $? -gt 0 ]];then
    exit $?
fi

echo "Starting nginx on port 80"
docker run --name nginx -t -d \
    -v $project_root:/var/lendsnap \
    -p 80:80 \
    --link db:db \
    --link node-webapp:node \
    nginx
if [[ $? -gt 0 ]];then
    exit $?
fi
